import { Morpher, TransformPoint, buildTransformableImage } from '../../build';

import { loadImageData } from './utils';

const imageAPoints = [
  262.610474, 612.866455,
  268.557007, 670.765015,
  276.481995, 708.760010,
  287.541016, 745.957947,
  304.095978, 780.903931,
  326.846985, 812.377930,
  353.958008, 840.469055,
  383.601959, 865.492920,
  416.757019, 884.979919,
  454.791962, 892.650024,
  491.966980, 885.440002,
  524.184998, 866.668030,
  553.189941, 842.624023,
  579.569946, 815.287964,
  601.659973, 784.554016,
  617.789978, 750.426025,
  628.750000, 713.980957,
  636.800049, 676.652954,
  644.896729, 619.550903,
  288.354980, 552.203979,
  320.673950, 549.978027,
  353.496948, 551.387085,
  386.108948, 555.747925,
  418.672974, 558.027954,
  390.755981, 535.682007,
  354.598999, 529.517029,
  318.031067, 530.554932,
  616.829956, 556.295898,
  585.750000, 553.552979,
  554.269775, 554.250977,
  523.071960, 558.069946,
  491.922058, 560.301025,
  518.286987, 538.322998,
  553.180176, 533.026978,
  588.290039, 535.443970,
  326.916016, 598.681458,
  343.730957, 606.161987,
  362.794952, 609.586914,
  382.095978, 608.297974,
  400.695007, 603.818970,
  386.584320, 587.654297,
  365.941406, 581.488831,
  344.267517, 585.152405,
  364.167877, 596.845398,
  364.426971, 592.671997,
  580.869995, 604.036255,
  564.319885, 610.875977,
  545.760071, 614.140015,
  527.033081, 612.860962,
  509.059937, 608.345947,
  522.685791, 592.362305,
  542.853027, 586.612793,
  563.861084, 590.590881,
  544.518738, 601.738586,
  542.229980, 599.365967,
  428.932953, 606.307007,
  427.859406, 679.563110,
  405.620911, 708.428711,
  432.841034, 725.819336,
  457.288025, 740.745972,
  481.988464, 728.843811,
  510.518982, 716.674927,
  486.893616, 679.906433,
  483.115479, 608.570496,
  458.791992, 713.007935,
  383.724030, 768.510010,
  530.939941, 767.645020,
  402.834991, 791.892944,
  428.012024, 808.245056,
  457.966949, 812.988953,
  486.955963, 807.187012,
  511.679962, 790.737000,
  495.050018, 778.204529,
  457.792816, 781.771790,
  420.670441, 778.718018,
  412.085999, 767.237000,
  439.991974, 764.356995,
  459.106964, 770.052979,
  478.007965, 764.428955,
  503.897980, 767.347900,
  494.817963, 776.637939,
  457.792816, 781.771790,
  421.533997, 776.952515,
  456.024170, 607.438721,
  455.297485, 559.164551,
  458.197479, 755.399414,
  299.874146, 356.893890,
  464.391876, 461.509155,
  608.550049, 365.448517,
  454.760406, 474.131470,
  268.733459, 554.359009,
  636.973511, 562.209839,
  547.450562, 445.412598,
  612.987671, 494.787292,
  457.612701, 427.302673,
  363.161377, 444.358765,
  294.033569, 490.859985
];

const imageBPoints = [
  298.699463, 483.173950,
  312.489929, 520.165039,
  324.413025, 543.585999,
  338.872925, 565.567993,
  356.755981, 584.945984,
  377.679077, 601.328003,
  400.339050, 615.468994,
  424.033020, 627.721008,
  449.187012, 635.723999,
  475.491943, 634.716980,
  497.934998, 623.695007,
  514.864990, 605.497986,
  529.380005, 585.094971,
  542.960022, 563.940979,
  554.689941, 541.683960,
  563.240112, 518.087036,
  568.620117, 493.561035,
  571.609863, 468.627991,
  570.260010, 430.963013,
  319.741028, 445.249023,
  338.242981, 438.228027,
  357.441040, 433.179993,
  376.997070, 430.343018,
  396.500000, 427.219971,
  377.206055, 416.840942,
  354.739990, 419.094971,
  333.843994, 427.460022,
  543.549927, 397.846008,
  524.923035, 400.867981,
  506.440002, 405.346985,
  488.287048, 411.096985,
  469.938965, 415.664917,
  483.801941, 400.302002,
  503.418945, 392.768982,
  524.107910, 389.355957,
  342.183960, 465.945374,
  355.389038, 470.393921,
  369.980042, 470.414917,
  384.016968, 466.135010,
  396.918030, 459.328979,
  384.333618, 449.090820,
  368.158875, 447.518066,
  352.670166, 453.475830,
  369.157471, 459.687744,
  367.585022, 456.958984,
  531.769897, 425.950012,
  523.118958, 435.622986,
  510.609070, 442.299988,
  496.619019, 444.744019,
  482.567932, 444.214966,
  488.807373, 430.053833,
  502.021973, 421.946289,
  517.681152, 420.314941,
  506.497437, 432.605713,
  502.768982, 430.421997,
  418.505554, 455.557495,
  429.164917, 507.413757,
  415.947083, 536.890015,
  438.206970, 544.310974,
  459.527039, 545.856995,
  477.630066, 536.567993,
  492.851074, 521.364990,
  471.106262, 499.182373,
  461.330505, 448.000488,
  456.487915, 527.882019,
  420.617004, 581.833008,
  503.530029, 564.544006,
  433.895020, 592.534973,
  449.868042, 598.919983,
  467.500000, 598.434021,
  483.275085, 592.221008,
  495.372986, 579.973999,
  484.198914, 572.028503,
  464.872009, 578.861023,
  442.772034, 580.583008,
  435.393066, 573.166992,
  450.932983, 565.205017,
  463.278015, 566.653015,
  473.864014, 561.085022,
  488.605042, 562.703979,
  484.109924, 570.144531,
  464.890991, 576.341003,
  442.967529, 578.670532,
  439.917908, 451.778992,
  433.219482, 421.442505,
  461.402527, 556.255005,
  284.028992, 316.421783,
  429.882385, 378.313080,
  534.159973, 266.805054,
  420.309021, 357.700989,
  297.138916, 442.715576,
  556.954590, 394.688110,
  486.184204, 332.311401,
  537.993042, 358.680389,
  415.189758, 322.639587,
  356.157043, 338.758606,
  312.951721, 382.705170
];

main().catch(console.error);

async function main() {
  let imageA = document.getElementById('image-a') as HTMLImageElement;
  let imageB = document.getElementById('image-b') as HTMLImageElement;

  let dataA = loadImageData(imageA, 900, 1600);
  let dataB = loadImageData(imageB, 900, 1600);

  let pointsA = buildPointsFromArray(imageAPoints);
  let pointsB = buildPointsFromArray(imageBPoints);

  let transformableImageA = buildTransformableImage(dataA, imageAPoints);
  let transformableImageB = buildTransformableImage(dataB, imageBPoints);

  let morpher = new Morpher(transformableImageA, transformableImageB);

  let startTime = Date.now();

  let result = morpher.morph(0.5);

  let endTime = Date.now();

  let canvas = document.getElementById('output-canvas') as HTMLCanvasElement;

  let context = canvas.getContext('2d')!;

  context.putImageData(result, 0, 0);

  context.globalAlpha = 0.3;
  context.fillStyle = '#fff';
  context.fillRect(0, 0, 900, 1600);
  context.globalAlpha = 1;

  for (let [index, point] of pointsB.entries()) {
    context.strokeStyle = '#ff0000';
    context.beginPath();
    context.arc(point.x, point.y, 1, 0, 2 * Math.PI);
    context.stroke();
    context.fillStyle = '#ff0000';
    context.font = '9px';
    context.fillText(String(index), point.x, point.y);
  }

  for (let [index, point] of pointsA.entries()) {
    context.strokeStyle = '#0000ff';
    context.beginPath();
    context.arc(point.x, point.y, 1, 0, 2 * Math.PI);
    context.stroke();
    context.fillStyle = '#0000ff';
    context.font = '9px';
    context.fillText(String(index), point.x, point.y);
  }

  console.info('Time cost:', `${endTime - startTime}ms`);
}

function buildPointsFromArray(arr: number[]): TransformPoint[] {
  let points: TransformPoint[] = [];

  arr = [...arr];

  while (arr.length) {
    let [a, b] = arr.splice(0, 2);

    if (a && b) {
      points.push({ x: a, y: b });
    }
  }

  return points;
}
